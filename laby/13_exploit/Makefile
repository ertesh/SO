CC=gcc 
CFLAGS=-O0 -c -m32 -Wall
LD=gcc
LDFLAGS= -Wall -m32
OBJDUMP=objdump -d
AS=as
ASFLAGS=--32


all: exploit server payload exec demo

exploit.o: exploit.c
	${CC} ${CFLAGS} exploit.c

server.o: server.c
	${CC} ${CFLAGS} server.c

payload.o: payload.s
	${AS} ${ASFLAGS} -o payload.o payload.s

exec.o: exec.c
	${CC} ${CFLAGS} exec.c

demo.o: demo.c
	${CC} ${CFLAGS} demo.c

dump_vdso.o: dump_vdso.c
	${CC} ${CFLAGS} dump_vdso.c

exploit: exploit.o
	${LD} ${LDFLAGS} -o exploit exploit.o

server: server.o
	${LD} ${LDFLAGS} -o server server.o

payload: payload.o
	${LD} ${LDFLAGS} -o payload payload.o

exec: exec.o
	${LD} ${LDFLAGS} -o exec -static exec.o

demo: demo.o
	${LD} ${LDFLAGS} -o demo demo.o

dump_vdso: dump_vdso.o
	${LD} ${LDFLAGS} -o dump_vdso dump_vdso.o

vdso: dump_vdso
	./dump_vdso > vdso

show-vdso: vdso
	@ ${OBJDUMP} vdso

clean:
	rm -f exploit server payload exec demo dump_vdso exploit.o server.o payload.o exec.o demo.o dump_vdso.o vdso

show-payload: payload.o
	@ echo Payload:
	@ ${OBJDUMP} payload.o | grep "[0-9a-f]:" | cut -f 2 | tr "\n\t" " " | tr -s " " | sed "s/\([0-9a-f][0-9a-f]*\)/0x\1/g" | sed "s/ \([0-9a-f]\)/, \1/g"
	@ echo

show-exec: exec
	@ ${OBJDUMP} exec | ${PAGER}
